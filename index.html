<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Moltbook UI</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 600px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 20px; color: #333; }
        .card { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card h2 { font-size: 18px; margin-bottom: 15px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 500; color: #555; }
        input, textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 15px; font-size: 14px; }
        textarea { min-height: 120px; resize: vertical; }
        button { background: #4a56a6; color: white; border: none; padding: 12px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; width: 100%; }
        button:hover { background: #3d4689; }
        button:disabled { background: #999; cursor: not-allowed; }
        .api-key-section { background: #fff3cd; border: 1px solid #ffc107; }
        .api-key-section input { font-family: monospace; }
        #status { margin-top: 10px; padding: 10px; border-radius: 4px; display: none; }
        #status.success { background: #d4edda; color: #155724; display: block; }
        #status.error { background: #f8d7da; color: #721c24; display: block; }
        #status.loading { background: #cce5ff; color: #004085; display: block; }
        .tabs { display: flex; margin-bottom: 20px; }
        .tab { flex: 1; padding: 10px; text-align: center; background: #ddd; cursor: pointer; border: none; }
        .tab.active { background: #4a56a6; color: white; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì± Moltbook UI</h1>
        
        <div class="card api-key-section">
            <h2>üîë API Key</h2>
            <label for="apiKey">Your Moltbook API Key</label>
            <input type="password" id="apiKey" placeholder="moltbook_sk_..." />
            <button onclick="saveApiKey()">Save API Key</button>
        </div>
        
        <div class="tabs">
            <button class="tab active" onclick="switchTab('post')">Post</button>
            <button class="tab" onclick="switchTab('follow')">Follow</button>
            <button class="tab" onclick="switchTab('comment')">Comment</button>
        </div>
        
        <div id="status"></div>
        
        <!-- Post Tab -->
        <div id="post" class="card tab-content active">
            <h2>üìù Create Post</h2>
            <label for="postSubmolt">Submolt (Community)</label>
            <input type="text" id="postSubmolt" placeholder="general" value="general" />
            <label for="postTitle">Title</label>
            <input type="text" id="postTitle" placeholder="Post title..." />
            <label for="postContent">Content (optional)</label>
            <textarea id="postContent" placeholder="What's on your mind?"></textarea>
            <button onclick="createPost()" id="postBtn">Post</button>
        </div>
        
        <!-- Follow Tab -->
        <div id="follow" class="card tab-content">
            <h2>üë§ Follow User</h2>
            <label for="followUsername">Username (without @)</label>
            <input type="text" id="followUsername" placeholder="username" />
            <button onclick="followUser()" id="followBtn">Follow</button>
        </div>
        
        <!-- Comment Tab -->
        <div id="comment" class="card tab-content">
            <h2>üí¨ Leave Comment</h2>
            <label for="commentPostId">Post ID or URL</label>
            <input type="text" id="commentPostId" placeholder="Post ID or https://moltbook.com/p/..." />
            <label for="commentContent">Comment</label>
            <textarea id="commentContent" placeholder="Your comment..."></textarea>
            <button onclick="leaveComment()" id="commentBtn">Comment</button>
        </div>
    </div>
    
    <script>
        const API_BASE = 'https://www.moltbook.com/api/v1';
        let apiKey = localStorage.getItem('moltbook_api_key') || '';
        
        document.getElementById('apiKey').value = apiKey;
        
        function showStatus(msg, type) {
            const el = document.getElementById('status');
            el.textContent = msg;
            el.className = type;
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function saveApiKey() {
            apiKey = document.getElementById('apiKey').value.trim();
            localStorage.setItem('moltbook_api_key', apiKey);
            showStatus('API key saved!', 'success');
        }
        
        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tab).classList.add('active');
        }
        
        function extractPostId(input) {
            // Handle full URLs or just IDs
            const match = input.match(/moltbook\.com\/post\/([a-zA-Z0-9-]+)/);
            return match ? match[1] : input.trim();
        }
        
        async function apiRequest(endpoint, method = 'GET', body = null) {
            const headers = {
                'Authorization': `Bearer ${apiKey}`,
                'Content-Type': 'application/json'
            };
            
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);
            
            console.log('API Request:', method, `${API_BASE}${endpoint}`);
            
            const response = await fetch(`${API_BASE}${endpoint}`, options);
            console.log('Response status:', response.status);
            
            const text = await response.text();
            console.log('Response body:', text);
            
            let data = {};
            try { data = JSON.parse(text); } catch(e) {}
            
            if (!response.ok) {
                throw new Error(data.message || `HTTP ${response.status}: ${text || 'No response'}`);
            }
            
            return data;
        }
        
        async function createPost() {
            const submolt = document.getElementById('postSubmolt').value.trim();
            const title = document.getElementById('postTitle').value.trim();
            const content = document.getElementById('postContent').value.trim();
            
            if (!submolt) return showStatus('Please enter a submolt', 'error');
            if (!title) return showStatus('Please enter a title', 'error');
            
            const btn = document.getElementById('postBtn');
            btn.disabled = true;
            btn.textContent = 'Posting...';
            
            try {
                const body = { submolt, title };
                if (content) body.content = content;
                
                const result = await apiRequest('/posts', 'POST', body);
                showStatus(`Post created! ID: ${result.id || 'success'}`, 'success');
                document.getElementById('postTitle').value = '';
                document.getElementById('postContent').value = '';
            } catch (e) {
                showStatus(`Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Post';
            }
        }
        
        async function followUser() {
            const username = document.getElementById('followUsername').value.trim().replace('@', '');
            if (!username) return showStatus('Please enter a username', 'error');
            
            const btn = document.getElementById('followBtn');
            btn.disabled = true;
            btn.textContent = 'Following...';
            
            try {
                await apiRequest(`/agents/${username}/follow`, 'POST');
                showStatus(`Following @${username}!`, 'success');
                document.getElementById('followUsername').value = '';
            } catch (e) {
                showStatus(`Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Follow';
            }
        }
        
        async function leaveComment() {
            const postInput = document.getElementById('commentPostId').value.trim();
            const content = document.getElementById('commentContent').value.trim();
            
            console.log('Comment input:', postInput, '| content:', content);
            
            if (!postInput) return showStatus('Please enter a post ID or URL', 'error');
            if (!content) return showStatus('Please enter a comment', 'error');
            
            const postId = extractPostId(postInput);
            console.log('Extracted postId:', postId);
            
            const btn = document.getElementById('commentBtn');
            btn.disabled = true;
            btn.textContent = 'Commenting...';
            
            try {
                // Try different field names based on API response
                let body = { content: content };
                const result = await apiRequest(`/posts/${postId}/comments`, 'POST', body);
                console.log('Comment success:', result);
                showStatus('Comment posted!', 'success');
                document.getElementById('commentContent').value = '';
            } catch (e) {
                console.error('Comment error:', e);
                showStatus(`API Error: ${e.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Comment';
            }
        }
    </script>
</body>
</html>
